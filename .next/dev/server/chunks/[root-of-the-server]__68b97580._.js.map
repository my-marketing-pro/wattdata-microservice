{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jzamudio/Desktop/mmp/watt-data/lib/mcp-agent.ts"],"sourcesContent":["import Anthropic from '@anthropic-ai/sdk';\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { StreamableHTTPClientTransport } from '@modelcontextprotocol/sdk/client/streamableHttp.js';\n\nexport interface MCPTool {\n  name: string;\n  description: string;\n  inputSchema: any;\n}\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant';\n  content: string | any[];\n}\n\nexport interface AgentResponse {\n  response: string;\n  toolCalls?: Array<{\n    name: string;\n    input: any;\n    result: any;\n  }>;\n}\n\nexport class MCPAgent {\n  private anthropic: Anthropic;\n  private mcpClient: Client | null = null;\n  private availableTools: MCPTool[] = [];\n  private connected = false;\n\n  constructor() {\n    this.anthropic = new Anthropic({\n      apiKey: process.env.ANTHROPIC_API_KEY!,\n    });\n  }\n\n  async initialize() {\n    if (this.connected) return;\n\n    console.log('Initializing MCP client connection...');\n\n    this.mcpClient = new Client({\n      name: 'watt-data-web',\n      version: '1.0.0',\n    }, {\n      capabilities: {\n        tools: {},\n      },\n    });\n\n    const serverUrl = process.env.MCP_SERVER_URL!;\n    const apiKey = process.env.MCP_SERVER_API_KEY!;\n    const authType = process.env.MCP_AUTH_TYPE || 'basic';\n\n    const headers: Record<string, string> = {};\n\n    if (authType === 'basic') {\n      headers['Authorization'] = `Basic ${apiKey}`;\n    } else if (authType === 'bearer') {\n      headers['Authorization'] = `Bearer ${apiKey}`;\n    } else if (authType === 'custom') {\n      headers['X-API-Key'] = apiKey;\n    }\n\n    const transport = new StreamableHTTPClientTransport(\n      new URL(serverUrl),\n      {\n        requestInit: {\n          headers: headers\n        }\n      }\n    );\n\n    await this.mcpClient.connect(transport);\n    console.log('MCP client connected successfully');\n\n    const toolsList = await this.mcpClient.listTools();\n    this.availableTools = toolsList.tools.map(tool => ({\n      name: tool.name,\n      description: tool.description,\n      inputSchema: tool.inputSchema,\n    }));\n\n    console.log(`Available tools: ${this.availableTools.length}`);\n    this.connected = true;\n  }\n\n  private getMCPToolsForClaude() {\n    return this.availableTools.map(tool => ({\n      name: tool.name,\n      description: tool.description,\n      input_schema: tool.inputSchema,\n    }));\n  }\n\n  private async executeToolCall(toolName: string, toolInput: any) {\n    if (!this.mcpClient) {\n      throw new Error('MCP client not initialized');\n    }\n\n    console.log(`Executing tool: ${toolName}`);\n    const result = await this.mcpClient.callTool({\n      name: toolName,\n      arguments: toolInput,\n    });\n\n    return result;\n  }\n\n  async chat(messages: ChatMessage[]): Promise<AgentResponse> {\n    if (!this.connected) {\n      await this.initialize();\n    }\n\n    const tools = this.getMCPToolsForClaude();\n    const toolCalls: Array<{ name: string; input: any; result: any }> = [];\n\n    let response = await this.anthropic.messages.create({\n      model: process.env.CLAUDE_MODEL || 'claude-sonnet-4-5',\n      max_tokens: 4096,\n      tools: tools,\n      messages: messages.map(msg => ({\n        role: msg.role,\n        content: msg.content,\n      })),\n    });\n\n    console.log('Initial response received');\n\n    // Agentic loop: handle tool calls\n    while (response.stop_reason === 'tool_use') {\n      const toolUseBlock = response.content.find((block: any) => block.type === 'tool_use');\n\n      if (!toolUseBlock) break;\n\n      console.log(`Claude wants to use tool: ${toolUseBlock.name}`);\n\n      // Execute the tool via MCP\n      const toolResult = await this.executeToolCall(toolUseBlock.name, toolUseBlock.input);\n\n      // Track tool calls for response\n      toolCalls.push({\n        name: toolUseBlock.name,\n        input: toolUseBlock.input,\n        result: toolResult,\n      });\n\n      // Add assistant response and tool result to messages\n      messages.push({\n        role: 'assistant',\n        content: response.content,\n      });\n\n      messages.push({\n        role: 'user',\n        content: [\n          {\n            type: 'tool_result',\n            tool_use_id: toolUseBlock.id,\n            content: JSON.stringify(toolResult.content),\n          },\n        ],\n      });\n\n      // Get next response from Claude\n      response = await this.anthropic.messages.create({\n        model: process.env.CLAUDE_MODEL || 'claude-sonnet-4-5',\n        max_tokens: 4096,\n        tools: tools,\n        messages: messages as any,\n      });\n    }\n\n    // Extract final text response\n    const finalResponse = response.content\n      .filter((block: any) => block.type === 'text')\n      .map((block: any) => block.text)\n      .join('\\n');\n\n    return {\n      response: finalResponse,\n      toolCalls: toolCalls.length > 0 ? toolCalls : undefined,\n    };\n  }\n\n  async cleanup() {\n    if (this.mcpClient) {\n      await this.mcpClient.close();\n      console.log('MCP client connection closed');\n      this.connected = false;\n    }\n  }\n\n  getAvailableTools(): MCPTool[] {\n    return this.availableTools;\n  }\n}\n\n// Singleton instance for server-side use\nlet agentInstance: MCPAgent | null = null;\n\nexport function getAgent(): MCPAgent {\n  if (!agentInstance) {\n    agentInstance = new MCPAgent();\n  }\n  return agentInstance;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 207, "column": 0}, "map": {"version":3,"sources":["file:///Users/jzamudio/Desktop/mmp/watt-data/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getAgent } from '@/lib/mcp-agent';\nimport { ChatMessage } from '@/lib/mcp-agent';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { messages, uploadedData } = body;\n\n    if (!messages || !Array.isArray(messages)) {\n      return NextResponse.json(\n        { error: 'Messages array is required' },\n        { status: 400 }\n      );\n    }\n\n    // Get the singleton agent instance\n    const agent = getAgent();\n\n    // If there's uploaded data, add context to the first user message\n    let chatMessages: ChatMessage[] = messages;\n\n    if (uploadedData && uploadedData.rows && uploadedData.rows.length > 0) {\n      // Add context about uploaded data\n      const dataContext = `\nI have uploaded a CSV file with the following information:\n- Total rows: ${uploadedData.rows.length}\n- Detected fields: ${JSON.stringify(uploadedData.detectedFields)}\n- Column headers: ${uploadedData.headers.join(', ')}\n- First 3 rows (sample):\n${JSON.stringify(uploadedData.rows.slice(0, 3), null, 2)}\n\nIMPORTANT: When using resolve_identities tool, you MUST use this exact format:\n{\n  \"id_type\": \"email\",\n  \"id_hash\": \"plaintext\",\n  \"identifiers\": [\"email1@example.com\", \"email2@example.com\"]\n}\n\nFor phone numbers:\n{\n  \"id_type\": \"phone\",\n  \"id_hash\": \"plaintext\",\n  \"identifiers\": [\"+15551234567\"]\n}\n\nFor addresses:\n{\n  \"id_type\": \"address\",\n  \"id_hash\": \"plaintext\",\n  \"identifiers\": [\"123 Main St, City, State ZIP\"]\n}\n\nPlease help me enrich this data using the Watt Data tools.\n`;\n\n      // Only add context if this is the first message about the uploaded data\n      const hasDataContext = messages.some((m: ChatMessage) =>\n        typeof m.content === 'string' && m.content.includes('uploaded a CSV file')\n      );\n\n      if (!hasDataContext && messages.length > 0) {\n        chatMessages = [\n          ...messages.slice(0, -1),\n          {\n            role: 'user',\n            content: messages[messages.length - 1].content + '\\n\\n' + dataContext,\n          }\n        ];\n      }\n    }\n\n    // Get response from agent\n    const result = await agent.chat(chatMessages);\n\n    return NextResponse.json({\n      response: result.response,\n      toolCalls: result.toolCalls,\n    });\n\n  } catch (error) {\n    console.error('Error in chat API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,GAAG;QAEnC,IAAI,CAAC,YAAY,CAAC,MAAM,OAAO,CAAC,WAAW;YACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,mCAAmC;QACnC,MAAM,QAAQ,IAAA,iIAAQ;QAEtB,kEAAkE;QAClE,IAAI,eAA8B;QAElC,IAAI,gBAAgB,aAAa,IAAI,IAAI,aAAa,IAAI,CAAC,MAAM,GAAG,GAAG;YACrE,kCAAkC;YAClC,MAAM,cAAc,CAAC;;cAEb,EAAE,aAAa,IAAI,CAAC,MAAM,CAAC;mBACtB,EAAE,KAAK,SAAS,CAAC,aAAa,cAAc,EAAE;kBAC/C,EAAE,aAAa,OAAO,CAAC,IAAI,CAAC,MAAM;;AAEpD,EAAE,KAAK,SAAS,CAAC,aAAa,IAAI,CAAC,KAAK,CAAC,GAAG,IAAI,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;;;AAwBzD,CAAC;YAEK,wEAAwE;YACxE,MAAM,iBAAiB,SAAS,IAAI,CAAC,CAAC,IACpC,OAAO,EAAE,OAAO,KAAK,YAAY,EAAE,OAAO,CAAC,QAAQ,CAAC;YAGtD,IAAI,CAAC,kBAAkB,SAAS,MAAM,GAAG,GAAG;gBAC1C,eAAe;uBACV,SAAS,KAAK,CAAC,GAAG,CAAC;oBACtB;wBACE,MAAM;wBACN,SAAS,QAAQ,CAAC,SAAS,MAAM,GAAG,EAAE,CAAC,OAAO,GAAG,SAAS;oBAC5D;iBACD;YACH;QACF;QAEA,0BAA0B;QAC1B,MAAM,SAAS,MAAM,MAAM,IAAI,CAAC;QAEhC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,UAAU,OAAO,QAAQ;YACzB,WAAW,OAAO,SAAS;QAC7B;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyB,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAAgB,GACpG;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}